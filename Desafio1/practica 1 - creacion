def validarUsuario(login){
    return sh(script: "getent passwd ${login}", returnStdout: true).trim().length() > 0;
}
pipeline {
    agent any

    parameters {
        string (name: 'login', defaultValue: '', description: 'username/login')
        string (name: 'nombre', defaultValue: '', description: 'nombre de usuario')
        string (name: 'apellido', defaultValue: '', description: 'nombre del usuario')
        choice (name: 'departamento', choices: ['contabilidad','finanzas','tecnologia'], description: 'Selecciona el departamento')
    }

    stages {
        stage('Validacion de datos') {
            steps {
                echo "Registrando al usuario ${params.login}"
                echo "Nombre: ${params.nombre}"
                echo "Apellido: ${params.apellido}"
            }
        }
        stage('Validacionde usuario') {
            if(validarUsuario(params.login)){
                echo "El usuario ya est치 registrado."
                error "El usuario ${params.login} no existe"
            }
        }
        stage('Generacion de password'){
            steps {
                script {
                    // Se genera la password random usando openssl y lo retornamos al usuario
                    PASSWORD = sh(script: 'openssl rand -base64 12', returnStdout: true).trim()
                    echo "Se gener칩 la pssword ${PASSWORD}"
                }
            }
        }
        stage('Creacion del Usuario'){
            steps {
                script {
                        sh "sudo useradd -m -c '${params.nombre} ${params.apellido}' ${params.login}"
                        echo "Se gener칩 el usuario ${params.login}!!"
                        sh "sudo usermod -aG ${params.departamento} ${params.login}"
                        sh "echo '${params.login}:${PASSWORD}' | sudo chpasswd"
                        echo "Se asign칩 la password ${PASSWORD}"
                }
            }
        }
    }
}
